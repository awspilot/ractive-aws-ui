(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?factory(exports):typeof define==="function"&&define.amd?define(["exports"],factory):factory(global.RactiveWindow={})})(this,function(exports){"use strict";var _slicedToArray=function(arr,i){if(Array.isArray(arr)){return arr}else if(Symbol.iterator in Object(arr)){var _arr=[];for(var _iterator=arr[Symbol.iterator](),_step;!(_step=_iterator.next()).done;){_arr.push(_step.value);if(i&&_arr.length===i)break}return _arr}else{throw new TypeError("Invalid attempt to destructure non-iterable instance")}};var template="		{{#_wnd_rendered}}			<div id='ractive-window-{{.id}}' 						class='ractive-window{{#(.buttons.length > 0)}} with-buttons{{/}}{{#.resizable}} resizable{{else}} fixed{{/}}{{#.geometry.state === 2}} maximized{{/}}{{#.class.window}} {{.class.window}}{{/}}{{#.topmost}} topmost{{/}}' 						on-click='_raise' 						style='{{#.hidden}}display: none;{{/}}top: {{.geometry.top}}px; left: {{.geometry.left}}px; {{#(.resizable || .geometry.state === 2)}}width: {{.geometry.width}}{{.geometry.dwunit}}; height: {{.geometry.height}}{{.geometry.dhunit}}; {{/}}z-index: {{.geometry.index}};{{#.style.window}} {{.style.window}}{{/}}'>\n							<div class='rw-modal' on-mousedown='_moveStart' style='{{^.blocked}}display: none;{{/}}'></div>\n  							<div class='rw-interior'>\n 								<div class='rw-controls'>{{>controls}}</div>\n  								<div class='rw-title' on-touchstart-mousedown='_moveStart' on-dblclick='_restore'>{{>title}}</div>\n  								{{#if dialog}}<div class='rw-dialog-cover'></div><div class='rw-dialog' style='width: {{dialog.width}}px; {{#if dialog.height}}height: {{dialog.height}}px; {{/if}}'>{{> ~/makePartial('sharedialog', dialog.raw) }}</div>{{/if}}								<div class='rw-body{{#.class.body}} {{.class.body}}{{/}}' {{#.style.body}}style='{{.style.body}}'{{/}}>{{>body}}</div>\n  								{{#(.buttons.length > 0)}}<div class='rw-buttons'>{{>buttons}}</div>{{/}}\n  								<div class='rw-resize-handle' on-touchstart-mousedown='_resizeStart'></div>\n   								<div class='rw-foot'>{{>foot}}</div>\n 							</div>\n			</div>		{{/}}";var Window;Window=Ractive.extend({template:template,prompt:function(message,cb){this.dialog({content:message,raw:"{{dialog.content}}<br><input class='form-control' value='{{dialog.reply}}' /> <div style='position: absolute;bottom: 10px;right: 10px;'><a class='btn btn-xs btn-default' on-click='@this.set(\"dialog\", false )'>Cancel</a> <a class='btn btn-xs btn-primary' on-click='dialog.callback.prompt:{{dialog}}'>OK</a></div>",width:300,cb:cb})},confirm:function(message,cb){this.dialog({content:message,raw:"{{dialog.content}} <div style='position: absolute;bottom: 10px;right: 10px;'><a class='btn btn-xs btn-default' on-click='@this.set(\"dialog\", false )'>Cancel</a> <a class='btn btn-xs btn-primary' on-click='dialog.callback.ok:{{dialog}}'>OK</a></div>",width:300,cb:cb})},dialog:function(opts){this.set("dialog",{content:opts.content,params:opts.params,raw:opts.raw,width:opts.width,height:opts.height,cb:opts.cb})},onconstruct:function(opts){var wnd=this;var sx,sy;var moveFn;moveFn=function(e){var x,y;e.preventDefault();if(e.type.indexOf("touch")>=0){x=+e.changedTouches[0].clientX;y=+e.changedTouches[0].clientY}else{x=+(e.x||e.clientX);y=+(e.y||e.clientY)}wnd.move(+wnd.get("geometry.left")+x-+sx,+wnd.get("geometry.top")+y-+sy);sx=x;sy=y;if(e.type==="mouseup"||e.type==="touchend"){document.removeEventListener("mousemove",moveFn,false);document.removeEventListener("mouseup",moveFn,false);document.removeEventListener("touchmove",moveFn,false);document.removeEventListener("touchend",moveFn,false)}};wnd.on("_moveStart",function(e){if(e.original.type==="mousedown"&&e.original.button===0||e.original.type==="touchstart"){wnd.restore();if(e.original.type.indexOf("touch")>=0){sx=+e.original.changedTouches[0].clientX;sy=+e.original.changedTouches[0].clientY}else{sx=+(e.original.x||e.original.clientX);sy=+(e.original.y||e.original.clientY)}document.addEventListener("mousemove",moveFn);document.addEventListener("mouseup",moveFn);document.addEventListener("touchmove",moveFn);document.addEventListener("touchend",moveFn);e.original.preventDefault()}$("iframe",wnd.element).focus()});var resizeFn;resizeFn=function(e){var x,y;e.preventDefault();if(e.type.indexOf("touch")>=0){x=e.changedTouches[0].clientX;y=e.changedTouches[0].clientY}else{x=+(e.x||e.clientX);y=+(e.y||e.clientY)}var w=+wnd.get("geometry.width")+(x-+sx);var h=+wnd.get("geometry.height")+(y-+sy);wnd.resize(w,h);sx=x;sy=y;if(e.type==="mouseup"||e.type==="touchend"){document.removeEventListener("mousemove",resizeFn,false);document.removeEventListener("mouseup",resizeFn,false);document.removeEventListener("touchmove",resizeFn,false);document.removeEventListener("touchend",resizeFn,false)}};wnd.on("_resizeStart",function(e){if(e.original.type=="mousedown"&&e.original.button===0||e.original.type==="touchstart"){wnd.restore();if(e.original.type.indexOf("touch")>=0){sx=e.original.changedTouches[0].clientX;sy=e.original.changedTouches[0].clientY}else{sx=e.original.x||e.original.clientX;sy=e.original.y||e.original.clientY}document.addEventListener("mousemove",resizeFn);document.addEventListener("mouseup",resizeFn);document.addEventListener("touchmove",resizeFn);document.addEventListener("touchend",resizeFn)}});var stateFn=function(target,e){switch(target){case"min":wnd.minimize();break;case"max":wnd.maximize();break;case"normal":wnd.restore();break;default:break}};wnd.on("dialog.callback.ok",function(e,dialog){this.set("dialog",false);try{dialog.cb()}catch(e){}});wnd.on("dialog.callback.prompt",function(e,dialog){try{dialog.cb(dialog.reply)}catch(e){}this.set("dialog",false)});wnd.on("_minimize",function(e){stateFn("min",e)});wnd.on("_restore",function(e){switch(wnd.get("geometry.state")){case 0:stateFn("max",e);break;case 1:case 2:stateFn("normal",e);break;default:break}});wnd.on("_raise",function(e){wnd.raise()});wnd.on("_close",function(e){wnd.close()});wnd.on("_dialog-button",function(e){var fn=e.context.action;if(!!fn&&typeof fn==="function")fn.call(this)});wnd.result=null;wnd.waitForClose=wnd.afterClose=new Promise(function(y,n){var fn=function(t){return function(v){wnd.completeAfterClose=null;wnd.rejectAfterClose=null;t(v)}};wnd.completeAfterClose=fn(y);wnd.rejectAfterClose=fn(n)})},onrender:function onrender(){var _this=this;if(!!!this.get("buttonClass")&&!!this.parent.get("buttonClass")){this.set("buttonClass",this.parent.get("buttonClass"))}this.watchers=this.observe({title:function(n,o){_this.fire("retitle",n,_this)},"geometry.state":function(n,o){switch(n){case 0:_this.fire("restore",n,_this);break;case 1:_this.fire("minimize",n,_this);break;case 2:_this.fire("maximize",n,_this);break}}})},onunrender:function onunrender(){if(this.watchers&&typeof this.watchers.cancel==="function")this.watchers.cancel()},activated:function activated(){},data:function data(){return{dialog:false,_wnd_rendered:false,blocked:false,resizable:true,geometry:{top:-9999,left:-9999,width:200,height:200,state:0,dwunit:"px",dhunit:"px",index:1e3,minimum:{x:0,y:0,width:70,height:50}},style:{},"class":{},makePartial:function makePartial(key,template){if(!this._makePartial_templates)this._makePartial_templates={};if(this._makePartial_templates[key]!=template){this.resetPartial(key,template);this._makePartial_templates[key]=template}return key}}},partials:{title:"{{> ~/makePartial('titleTpl', .title) }}",body:"",foot:"",buttons:"{{#.buttons:i}}<button on-click='_dialog-button' class='{{.position || ''}}{{#.buttonClass}} {{.buttonClass}}{{/}}{{#../../class.button}} {{../../class.button}}{{/}}' disabled='{{!.enabled}}'>{{> ~/makePartial('button' + i + 'Tpl', .label) }}</button>{{/}}",controls:"{{#controls:i}}"+"	{{#if .raw}}{{>  ~/makePartial('custom_control_template'+i, .raw) }}{{/if}}"+"{{/controls}}"+"{{#if minimizable === false}}{{else}}{{>minimizeControl}}{{/if}}"+"{{>restoreControl}}{{>closeControl}}",minimizeControl:"<button on-click='_minimize' class='btn btn-sm rw-minimize'><i class='zmdi zmdi-window-minimize'></button>",restoreControl:"<button on-click='_restore'  class='btn btn-sm rw-restore'><i class='zmdi zmdi-window-restore'></button>",closeControl:"<button on-click='_close'    class='btn btn-sm rw-close'><i class='zmdi zmdi-close'></i></button>"},rerender:function(){var wnd=this;if(!wnd.get("_wnd_rendered"))return Promise.resolve("ok");wnd.set("_wnd_rendered",false);return this.set("_wnd_rendered",true)},title:function(str){this.set("title",str)},move:function(x,y){if(typeof x==="string"){switch(x){case"center":case"centerScreen":return this.set({"geometry.top":(this.parent.el.clientHeight-this.element.clientHeight)/2,"geometry.left":(this.parent.el.clientWidth-this.element.clientWidth)/2});case"cascade":return this.set({"geometry.top":this.parentNumber%10*20+10,"geometry.left":this.parentNumber%50*20+10})}return Promise.resolve(false)}y=+y;x=+x;var min=this.get("geometry.minimum");var max=this.get("geometry.maximum");var w=+this.get("geometry.width");var h=+this.get("geometry.height");if(!!max){if(x+w>+max.x)x=+max.x-x;if(y+h>+max.y)y=+max.y-y}if(!!min){if(x<+min.x)x=+min.x;if(y<+min.y)y=+min.y}return this.set({"geometry.top":y,"geometry.left":x})},resize:function(w,h){w=getDimPx.call(this,"width",w);h=getDimPx.call(this,"height",h);var min=this.get("geometry.minimum");var max=this.get("geometry.maximum");if(!!max){if(w>max.width)w=max.width;if(w>max.height)w=max.height}if(!!min){if(w<min.width)w=min.width;if(h<min.height)h=min.height}this.set({"geometry.width":w,"geometry.height":h});$("iframe",this.element).focus()},resizable:function(b){this.set("resizable",b)},minimize:function(){var wnd=this;if(wnd.get("geometry.state")!==1){wnd.set({hidden:true,"geometry.state":1});wnd.fire("minimized",{window:wnd})}},maximize:function(){var wnd=this;if(wnd.get("geometry.state")!==2){wnd.normalGeometry={top:wnd.get("geometry.top"),left:wnd.get("geometry.left"),width:wnd.get("geometry.width"),height:wnd.get("geometry.height")};wnd.set({hidden:false,"geometry.left":0,"geometry.top":0,"geometry.width":100,"geometry.height":100,"geometry.dwunit":"%","geometry.dhunit":"%","geometry.state":2});wnd.fire("maximized",{window:wnd})}},restore:function(){var wnd=this;switch(wnd.get("geometry.state")){case 1:wnd.set({hidden:false,"geometry.state":0});break;case 2:var g=wnd.normalGeometry||{};wnd.normalGeometry=null;if(g.top<0||g.left<0){g.top=0;g.left=0}wnd.set({hidden:false,"geometry.left":g.left,"geometry.top":g.top,"geometry.width":g.width,"geometry.height":g.height,"geometry.dwunit":"px","geometry.dhunit":"px","geometry.state":0});break;default:break}this.raise()},raise:function(){if(!!this.parent)this.parent.raiseWindow(this)},kill:function(){var wnd=this;this.fire("close",this);if(!!wnd.parent){wnd.parent.killWindow(wnd)}else{wnd.teardown()}if(!!wnd.completeAfterClose)wnd.completeAfterClose(wnd.result)},content:function(ct){return this.resetPartial("body",ct)},buttons:function(){var arr=[],i;this.set("buttons",arr);if(arguments.length===1&&typeof arguments[0].length==="number"){arr=arguments[0]}else{for(i=0;i<arguments.length;i++){arr.push(arguments[i])}}var left=[],right=[],middle=[];for(i=0;i<arr.length;i++){var b=arr[i];if(!!b.position){if(b.position==="left")left.push(b);else if(b.position==="right")right.push(b);else if(b.position==="middle")middle.push(b);else if(b.position==="center")middle.push(b);else{right.push(b);b.position="right"}}else{right.push(b);b.position="right"}if(!b.hasOwnProperty("enabled"))b.enabled=true}arr=[];for(i=0;i<left.length;i++)arr.push(left[i]);for(i=right.length-1;i>=0;i--)arr.push(right[i]);for(i=0;i<middle.length;i++)arr.push(middle[i]);this.set("buttons",arr)},button:function(name,cb){var arr=this.get("buttons");var btn,i;if(typeof name==="number"){btn=arr[name];i=name}else for(i=0;i<arr.length;i++){if(arr[i].label===name){btn=arr[i];break}}if(!!btn){cb(btn);this.set("buttons."+i,btn)}},controls:function(){var arr=[],i,str="";if(arguments.length===1&&typeof arguments[0]!=="string")arr=arguments[0];else{for(i=0;i<arguments.length;i++)arr.push(arguments[i])}for(i=0;i<arr.length;i++)str+="{{>"+arr[i]+"Control}}";this.partials.controls=str;return this.rerender()},onClose:function(){this.kill()},close:function(fn){if(!!!fn)fn=this.onClose;if(fn.length===0)fn.call(this);else{var wnd=this;fn.call(this,function(close){if(close)wnd.kill()})}}});var cssUnit=/([\d\.]+)(.*)/;function getDimPx(dim,length){var _cssUnit$exec=cssUnit.exec(length.toString());var _cssUnit$exec2=_slicedToArray(_cssUnit$exec,3);var whole=_cssUnit$exec2[0];var size=_cssUnit$exec2[1];var unit=_cssUnit$exec2[2];unit=unit||"px";var dunit=dim==="width"?"dwunit":"dhunit";var div=this.find("div");if(unit==="px"){return size}else if(div){var toSet={};toSet["geometry."+dim]=size;toSet["geometry."+dunit]=unit;this.set(toSet);var v=this.find("div")["client"+dim[0].toUpperCase()+dim.substring(1)];toSet["geometry."+dim]=v;toSet["geometry."+dunit]="px";this.set(toSet);return v}}var messageButtons={ok:{label:"OK",action:function(){this.result="ok";this.close()},position:"middle"},cancel:{label:"Cancel",action:function(){this.result="cancel";this.close()},position:"middle"},yes:{label:"Yes",action:function(){this.result="yes";this.close()},position:"middle"},no:{label:"No",action:function(){this.result="no";this.close()},position:"middle"}};var WindowHost;WindowHost=function(){var counter=0;function newWindow(e,cb){var current=counter;counter+=1;var host=this;return host.push("windowSlots",current).then(function(){var pr;var wnds=host.findAllComponents("Window");var wnd=wnds[wnds.length-1];host.set("windows."+current,wnd);wnd.parentNumber=current;wnd.set({"geometry.index":1e3+wnds.length,"geometry.left":-9999,"geometry.top":-9999,id:current});var step1=function(){var mpr;if(!!cb&&typeof cb==="function"){try{mpr=cb(wnd);if(!!mpr&&typeof mpr.then==="function")return mpr}catch(e1){console.log(e1)}}else if(typeof e==="function"){try{mpr=e(wnd);if(!!mpr&&typeof mpr.then==="function")pr=mpr}catch(e2){console.log(e2)}}};pr=step1();var step2=function(){var mpr;wnd.raise();return wnd.set("_wnd_rendered",true).then(function(){wnd.element=wnd.find(".ractive-window");try{mpr=wnd.activated();if(!!mpr&&typeof mpr.then==="function")return mpr}catch(e4){console.log(e4)}})};if(!!pr)pr=pr.then(step2);else pr=step2();var step3=function(){var mpr;if(wnd.get("geometry.left")===-9999){return wnd.move("cascade").then(function(){return wnd})}return wnd};if(!!pr)pr=pr.then(step3);else pr=step3();return pr})}function messageBox(opts){var args=arguments;var host=this;return new Promise(function(y){host.newWindow(function(w){var message;if(args.length>=2){message=args[0];opts=args[1]}else if(args.length===1&&typeof args[0]==="string"){message=args[0];opts={}}w.set("title",opts.title||"Message");w.set("resizable",false);w.controls("close");w.content(message);var btns=opts.buttons||["ok"],out=[];for(var i=0;i<btns.length;i++)if(messageButtons.hasOwnProperty(btns[i]))out.push(messageButtons[btns[i]]);w.buttons(out);w.onClose=function(){this.kill();y(w.result||"none")};if(!opts.hasOwnProperty("modal")||opts.modal)host.set("globalBlock",w);w.activated=function(){w.move("center")}})})}return Ractive.extend({isolated:true,defaults:{control:{label:function label(control,lbl){Window.partials[control+"ControlLabel"]=lbl}},controls:function(){var partial="";for(var i=0;i<arguments.length;i++){partial+="{{>"+arguments[i]+"Control}}"}Window.partials.controls=partial}},components:{Window:Window},data:{windowSlots:[],windows:{},blocks:{},globalBlock:null},computed:{blocked:function(){return!!this.get("globalBlock")}},template:"<div class='ractive-window-host-modal' style='{{^blocked}}display: none;{{/blocked}}'></div><div class='host-content'>{{yield}}</div>{{#windowSlots}}<Window/>{{/windowSlots}}",newWindow:newWindow,killWindow:function(wnd){var blocks=this.get("blocks");var wnds=this.get("windows");var topWnd,topIdx=-1,i;if(!!wnds){for(var w in wnds){if(wnds[w]===wnd)delete wnds[w];else{i=wnds[w].get("geometry.index");if(i>topIdx){topIdx=i;topWnd=wnds[w]}}}if(topWnd&&!topWnd.get("topmost")){topWnd.set("topmost",true);$("iframe",topWnd.element).focus()}}var slots=this.get("windowSlots");if(!!slots){this.splice("windowSlots",slots.indexOf(wnd.parentNumber),1)}for(i in blocks){var arr=blocks[i];if(!!arr&&Array.isArray(arr)&&arr.indexOf(wnd.parentNumber)>=0)arr.splice(arr.indexOf(wnd.parentNumber),1)}if(wnd===this.get("globalBlock"))this.set("globalBlock",null);this.unblockUnblockedWindows()},raiseWindow:function(wnd){var wndso=this.get("windows");var slots=this.get("windowSlots");var blocks=this.get("blocks");var wnds=[];var target=this.topLevelBlockers(wnd);target.push(wnd);for(var k in wndso)if(target.indexOf(wndso[k])<0)wnds.push(wndso[k]);wnds.sort(function(a,b){var ai=a.get("geometry.index"),bi=b.get("geometry.index");if(ai<bi)return-1;else if(ai>bi)return 1;else return 0});if(!!wnd)wnds=wnds.concat(target);function moveBeforeBlocker(wnd,blockers){for(var i in blockers){var bl=wndso[blockers[i]];var wi=wnds.indexOf(wnd),bi=wnds.indexOf(bl);if(!!!bl||wi<0||bi<0)continue;var arr=blocks[bl.parentNumber];if(!!!arr&&Array.isArray(arr)&&arr.length>0)moveBeforeBlocker(bl,arr);if(wi>bi){wnds.splice(wi,1);wnds.splice(bi,0,wnd)}}}var i;for(i in slots){var arr=blocks[slots[i]];if(!!arr&&Array.isArray(arr)&&arr.length>0)moveBeforeBlocker(wndso[slots[i]],arr)}for(i in wnds){wnds[i].set("geometry.index",1e3+ +i);if(wnds[i]!==wnd){wnds[i].set("topmost",false)}}if(!wnd.get("topmost")){wnd.set("topmost",true);$("iframe",wnd.element).focus()}function globalBlocks(wnd){var res=[];if(!!!wnd){return res}var arr=blocks[wnd.parentNumber];if(!!arr&&Array.isArray(arr)&&arr.length>0){for(var i in arr){res=res.concat(globalBlocks(wndso[arr[i]]))}}res.push(wnd);return res}var globals=globalBlocks(this.get("globalBlock"));for(i in globals)globals[i].add("geometry.index",1e4)},topLevelBlockers:function(wnd){if(!!!wnd)return[];var blocks=this.get("blocks");var wndso=this.get("windows");var arr=blocks[wnd.parentNumber];var res=[];if(!!!arr||!Array.isArray(arr)||arr.length===0)return res;for(var i in arr){var arr2=blocks[arr[i]];if(!!!arr2||!Array.isArray(arr2)||arr2.length===0)res.push(wndso[arr[i]]);else{res=res.concat(this.topLevelBlockers(wndso[arr[i]]))}}return res},blockWindow:function(target,blocker){if(!!!target||!!!blocker)return;var blocks=this.get("blocks");var arr=blocks[target.parentNumber];if(!!!arr||!Array.isArray(arr))arr=[];if(arr.indexOf(blocker.parentNumber)<0)arr.push(blocker.parentNumber);blocks[target.parentNumber]=arr;for(var i=2;i<arguments.length;i++){if(arr.indexOf(arguments[i].parentNumber)<0)arr.push(arguments[i].parentNumber)}if(arr.length>0)target.set("blocked",true);this.raiseWindow()},unblockWindow:function(target,blocker){if(!!!target|!!!blocker)return;var blocks=this.get("blocks");var arr=blocks[target.parentNumber];if(!!!arr||!Array.isArray(arr))return;if(arr.indexOf(blocker.parentNumber)>=0)arr.splice(arr.indexOf(blocker.parentNumber),1);for(var i=2;i<arguments.length;i++){if(arr.indexOf(arguments[i].parentNumber)>=0)arr.splice(arr.indexOf(arguments[i].parentNumber),1)}if(arr.length===0)target.set("blocked",false);this.raiseWindow()},unblockUnblockedWindows:function(){var blocks=this.get("blocks");var wndso=this.get("windows");for(var i in blocks){var arr=blocks[i];if(!!!arr||!Array.isArray(arr)||arr.length===0){var wnd=wndso[i];if(!!wnd)wnd.set("blocked",false)}}},messageBox:messageBox})}();var Host=WindowHost;var res={Window:Window,WindowHost:Host};var index=res;exports["default"]=index});